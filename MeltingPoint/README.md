# 融点の推定

氷の結晶成長や融解過程をその場観察するとともに、氷の融点を計算機シミュレーションで推定する手順を解説します。

計算機シミュレーションに利用される水分子モデルには非常に多数の種類があります。そのうちのほとんどは、常温の液体の水や水溶液の性質が再現されるように設計されてきたため、結晶化相転移を観察するのに適していません。

ここでは、近年開発され、信頼性の高いTIP4P/Iceモデルを利用します。このモデルの1気圧での融点は270 Kと言われており[^1]、常温以下での水や氷やハイドレート(水和結晶)のふるまいを研究するのによく使われています。

氷の融点なんて、実験ですでにわかっているだろうって?その通りです。でも、コンピュータシミュレーションで用いる水分子モデルの融点が知りたいのです。モデルの質が悪ければ、融点は実験値とはあわないでしょう。分子シミュレーションの目的は、実験と合うデータを得ることではありません。実験を再現することを保証しつつ、実験では見えない情報をとりだすことに価値があります。融点などの物性をよく制限するモデルであれば、分子の運動もそれなりに正しく再現していると考えられます。そうであれば、例えば固液界面からどのように水が凍っていくのかをその場で観察した結果(これは実験では見えない)をも信頼できると期待できます。

## 1. 水分子モデルを選ぶ

TIP4P/Iceの分子モデルは`ice.top`に書かれています。

```
; taken from http://www.sklogwiki.org/SklogWiki/index.php/GROMACS_topology_file_for_the_TIP4P/Ice_model
[ defaults ]
; nbfunc        comb-rule       gen-pairs       fudgeLJ fudgeQQ
1             2               no              1.0     1.0

[atomtypes]
;name     mass      charge   ptype    sigma        epsilon
IW     0             0.000       D   0.0           0.0
OWT4   15.99940      0.000       A   0.31668       0.88211
HW     1.00800       0.000       A   0.00000E+00   0.00000E+00

...
```

全部で50行ぐらいのデータファイルで、ここには以下のような内容が書かれています。

* 1つの水分子をいくつの点で近似表現しているか。
* 分子の中での点の相対距離
* 点と点はどのように相互作用するか(Coulomb力とLennard-Jones力)
* 分子は点と点をバネでつないだ柔軟な物体として扱うのか、それとも剛直で変形しない剛体として扱うのか。

TIP4P/Iceの場合は

* 相互作用点は4点。
* H-H間距離は約0.15 nm、O-H間距離は約0.1 nm。
* 3つがCoulomb相互作用し、残る1点はLennard-Jones相互作用。
* 剛体として扱う。

となっています。

## 2. 分子を配置する

最初に、分子をどう配置するかは、あとのシミュレーションの成否に大きく関わります。

融点を推定する際に、例えば初期配置として、すべての分子が氷の結晶構造に並ぶ配置を選ぶと、融点より10 Kや20 K温度を上げても氷は融けません(過熱現象)。これは、融けはじめるきっかけとなる、構造の崩壊が偶然起こるまでの時間がかかりすぎるためです。もちろん、無限に近い計算時間があれば、融点より上では融けはじめるはずですが、そんなに長い計算は今のコンピュータでは不可能です。

同じように、はじめに完全に液体の状態からはじめると、温度をいくらさげても自然に結晶が生じることはまずありません。

そこで、融点を推定したい場合には、あらかじめ氷と水が共存する状態を準備します。こうすれば、設定した温度が融点よりも高ければ、氷は徐々に融けていきますし、低ければ氷の成長が見られます。

さらに、氷と水の界面が平坦であることも重要な条件です。もし、2つの相の間の界面が湾曲している場合、そこにはLaplace圧という圧力が生まれます。要するに、こちらが圧力を指示しても、界面が曲がることで圧力が変わってしまい、指示した圧力のもとでの融点がきちんと推定できない、ということになります。

初期配置は、次の手順で準備します。

1. GenIceツールを使い、氷の結晶構造を作ります。結晶は1:1:2の長い直方体形状になるようにします。
2. 水分子の半分を「固定」します。文字通り、最初の場所から動けなくします。
3. 温度を500 Kまで上げて、短い分子動力学シミュレーションを行います。固定した部分は構造を保ちますが、それ以外の水分子はすぐに融解します。
4. 温度を戻し、固定を解除します。これにより、液体と固体が半分ずつの初期構造ができます。
5. 固定を解除した状態で、270 K(融点)付近でしばらくシミュレーションを行い、構造を緩和させます。

以下に、具体的な手順を書きます。

### 2-1 氷の結晶を作る

[GenIce](https://github.com/vitroid/GenIce)は、さまざまな氷の結晶構造を生成するツールです。これを用い、氷Ih(六方晶氷I、もっとも身近に存在する氷)を生成します。

ターミナルで以下のように入力します。

```
genice2 1h -r 3 3 6 -w tip4p > ice.gro
```

`-r`オプションで、単位胞をx,y,z方向にいくつならべるかを指定しています。また、`-w`で水分子モデルの種類を指定します。

`ice.gro`の末尾には、こんな風に箱の大きさがnm単位で書かれています。
```
...
  863ICE    HW1 3450   2.178   1.983   5.379
  863ICE    HW2 3451   2.220   2.107   5.303
  863ICE     MW 3452   2.217   2.020   5.310
  864ICE     OW 3453   1.694   1.648   5.310
  864ICE    HW1 3454   1.740   1.620   5.231
  864ICE    HW2 3455   1.697   1.744   5.306
  864ICE     MW 3456   1.700   1.657   5.300
    2.34685163 2.20607179 5.42191111
```

x, y, z軸方向の寸法がそれぞれ2.3 nm, 2.2 nm, 5.4 nmで、z方向に長いセルです。

### 2-2 分子を固定する

`Gromacs`には、原子の番号を指定して、その原子を動けなくする機能があります。手で指定するのはたいへんなので、pythonスクリプトをつかって、Z座標が2.7 nm未満の原子だけを固定します。

#### 2-2-1 原子にインデックスをつける

Gromacsのmake_ndxコマンドは、原子を種類ごとに分類した`.ndx`ファイルを生成します。

```
gmx make_ndx -f ice.gro -o ice.ndx
```
を実行し、promptが表示されたら、qを押して終了します。ice.ndxには以下のような内容が書かれます。

```
[ System ]
   1    2    3    4    5    6    7    8    9   10   11   12   13   14   15
  16   17   18   19   20   21   22   23   24   25   26   27   28   29   30
  31   32   33   34   35   36   37   38   39   40   41   42   43   44   45
...
```

#### 2-2-2 固定した原子のインデックスを追加する

このファイルの末尾に、固定したい原子のインデックスを追加します。

```
python zfix.py 0.0 2.7 < ice.gro >> ice.ndx
```

これにより、`ice.ndx`ファイルの末尾に、以下のような行が追加されます。

```
...
[FIX]
1  2  3  4  5  6  7  8  9  10  11  12  13  14  15  16  17  18  19  20  21
22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40
41  42  43  44  45  46  47  48  49  50  51  52  53  54  55  56  57  58  59
...
```

### 2-3 残り半分を融かす

体積一定のままで、温度を500 Kまで上げます。普通なら沸騰しそうなものですが、膨張できないので、液体になるだけでとまります。このステップは、ただ構造を壊したいだけなので、長時間実行する必要はありません。

Gromacsでの分子動力学法の実行は、いつも3段階の手順になります。

1. 設定ファイルを「コンパイル」して、Gromacsが読みやすいデータ形式に変換する。
2. そのデータを読みこんで、分子動力学シミュレーションの本体(mdrun)を実行する。
3. 生成したデータを、人間が読みやすいように変換する。

### 2-3-1 コンパイル

拡張子`.mdp`には、分子動力学の実施方法を詳細に記載します。個々のパラメータの説明は、`fix.mdp`ファイルにコメントとして書きこんであります。計算時間、記録間隔、温度設定、圧力設定など、分子配置と相互作用以外のほぼすべての情報は`.mdp`に書きます。

以下のコマンドでこれをコンパイルして、`.tpr`ファイルを作ります。

```
gmx grompp -maxwarn 1 -f fix.mdp -p ice.top -o 00001.tpr -c ice.gro -n ice.ndx
```

これにより、Gromacsが読みこむファイル`00001.tpr`ができました。

### 2-3-2 実行

2-3-1で作った00001.tprを読みこんでシミュレーションを実行します!

```
gmx mdrun -deffnm 00001
```

これを実行すると、ほかにも`00001.`からはじまるたくさんのファイルが生成されます。(-deffnmは、たぶんdefault file nameの略で、明示的に指定しなかった出力ファイルには全部`00001.`をつけて下さい、と指示しています。)

* `00001.cpt`: チェックポイントファイル、続きの計算を行うのに必要なファイル。
* `00001.edr`: 温度や圧力などの、統計情報が含まれるファイル。
* `00001.trr`: 原子の座標や速度のデータ(トラジェクトリと呼ばれる)。
* `00001.log`: その他の記録。実行時間などもこのファイルに記録される。

`00001.log`の末尾には以下のように実行時間の情報が記録されます。

```
starting mdrun 'water TIP4P/Ice'
50000 steps,    100.0 ps.

Writing final coordinates.

               Core t (s)   Wall t (s)        (%)
       Time:      792.815       99.102      800.0
                 (ns/day)    (hour/ns)
Performance:       87.185        0.275
```

これはMacBook Airで実行したケースですが、

* CPUを800%使っている(8 core全部を使用している)
* 50000ステップ実行した。1ステップが0.002 psなので、100 psのシミュレーションが行われた。
* かかった時間は100秒。このペースだと一日で90 ns分の計算ができる。

といったことが読みとれます。


### 2-3-3 確認

シミュレーション結果を可視化するツール[VMD](https://www.ks.uiuc.edu/Research/vmd/alpha/)を使い、分子運動を可視化してみましょう。

まず、分子動力学計算で得られた分子配置を、可視化しやすいように変換します。

```
gmx trjconv -f 00001.trr -s 00001.tpr -pbc whole -o vis.gro
```

入力を求められたら、0を押してリターンを押します。(System全体を可視化します)

これで、vis.groファイルができました。かなり大きなファイルです。

1. 上のリンクから、VMDをダウンロードし、インストールします。(ユーザ登録を求められるかもしれません)

2. VMDを起動します。

3. VSCodeで、vis.groを右クリックしてダウンロードします。

4. Downloadしたファイルを、VMDのウィンドウにドラッグアンドドロップします。

固定した部分は、分子はびくとも動いていないことがわかります。一方、固定していない部分は完全にランダムになっています。

### 2-3-4 緩和

温度を下げ、原子の固定をはずして、構造を緩和させます。この時に、体積も変化できるようにし、圧力一定でのシミュレーションに切り替えます。

シミュレーションの設定はさきほどと同じ、`.mdp`に書きます。今回は`relax.mdp`を使用します。

VSCodeのファイル比較機能を使うと、`relax.mdp`と`fix.mdp`の違いがわかります。

変更されているのは3点。

1. 温度が500 Kから270 Kに下げられた。
2. 体積一定から圧力一定に切り替えた。
3. 分子の固定を外した。

これを使って、またコンパイルし、実行します。

```
gmx grompp -maxwarn 1 -f relax.mdp -p ice.top -o 00002.tpr -c 00001.tpr -t 00001.cpt  > 00002.grompp.log
gmx mdrun -deffnm 00002
```

2-3-3と同じように、`vis.gro`を作って、VMDで観察して下さい。今度は、氷の部分の分子もぷるぷると振動していることがわかります。

## 3. 目標とする温度で、シミュレーションを行う

2.で作った構造を初期配置とし、いろんな温度で長時間のシミュレーションを行います。

作業を行うディレクトリをわけ、結果が上書きされないようにします。

圧力は1気圧、シミュレーション時間は1 nsを目標とします。このシミュレーションではdt=0.002 psとしていますので、1 nsは500 000ステップに相当します。(本当は、最低でも10 ns程度は調べたいところです)

温度は250 Kとします。これは、TIP4P/Iceの融点[^1]に対して20 Kも低温なので、氷はただちに成長すると予想されます。

## 3-1 作業環境の準備

初期配置を作ったフォルダーとは別のところで作業したほうが良いでしょう。

VSCodeを使い、ディレクトリ(フォルダー)を作ります。"New Folder"ボタン![New Foler](https://i.gyazo.com/b045bf92b0be46d81c754fbb2b6a6385.png) を押し、フォルダー名は`250K`としましょう。

継続計算用の設定ファイル`continue.mdp`をVSCodeで開き、温度設定を250 Kに修正して、`250K/`フォルダーに**別名で保存**します。ファイル名は`250K.mdp`としておきましょう。

`relax.mdp`と`continue.mdp`を比較して下さい。主な変更点は3点です。

1. 実行ステップ数を10倍(1 ns)に変更。
2. 温度制御法を、より精密なNose-Hoover法に変更。
3. 圧力制御法を、より精密なParrinello-Rahman法に変更。

ターミナルでの作業も、`250K/`フォルダーに移動します。

```
cd 250K
```


## 3-2 シミュレーションの実行

そして、`250K`フォルダー内で設定ファイルをコンパイルします。その他のファイルは、一つ上のフォルダーにあるものを流用します。
```
gmx grompp -maxwarn 1 -f 250K.mdp -p ../ice.top -o 00001.tpr -c ../00002.tpr -t ../00002.cpt > 00001.grompp.log
```

実行!

```
gmx mdrun -deffnm 00001
```

さっきの10倍の時間がかかるはずです。コーヒーでも飲んで、気長に待ちましょう。

## 3-3 延長

あとの解析で、まだシミュレーションの時間が足りないことがわかった場合は、次のようにして計算を延長することができます。

まず、さきほどgrompppで生成した.tprファイルの、実行時間を延長した新しい.tprファイルを作成します。 `-extend`オプションは追加計算する時間をps単位で指定します。元1 ns+追加2 nsなので、ファイル名は3nsとしました。

```
gmx convert-tpr -extend 2000 -s 00001.tpr -o 3ns.tpr
```

そして実行!

```
gmx mdrun -deffnm 00002 -cpi 00001.cpt -s 3ns.tpr -noappend
```

こんどは食事ができるぐらい時間がかかるかもしれません。
## 4. 結果の可視化

実際にどんなことが起こっているのかを確認するために、分子座標データを手許のコンピュータに転送し、VMDで分子運動を表示させてみましょう。

まず、トラジェクトリデータ`.trr`を、人間が読める`.gro`形式に変換します。

```
gmx trjconv -f 00001.trr -s 00001.tpr -pbc whole -o vis.gro
```

これをDownloadし、VMDで開きます。

すこしだけ結晶が成長しているようにも思えますが、1 nsでは全然時間が足りていないようですね。

もっと温度を下げればより速く凍るか、というとそうでもなくて、温度が低いと分子運動が遅くなるせいで、結晶成長も遅くなります。

温度が高ければ高いほどはやく融けるのは間違いないので、290 Kでシミュレーションしてみると良いかもしれませんね。


## 5. 判定

圧力と温度一定でシミュレーションした場合、液体になるか固体になるかで体積が違ってきます。同時に、ポテンシャルエネルギーも違います。固体のほうが必ず(エントロピーが低いので)ポテンシャルエネルギーも低くなるはずです。つまり、ポテンシャルエネルギーの時間変化を見れば、氷が成長しつつあるのか、融解しつつあるのかを見分けることができます。

これをプロットして確認します。

可視化しても成長の陽子が目に見えてわかるようになるまでには、かなり時間を要することがわかります。そこで、違うアプローチをとります。

結晶化が進行していれば、ポテンシャルエネルギーは徐々に下がっていくはずです。一方、融解が進行していれば、ポテンシャルエネルギーは上昇するはずです。そこで、ポテンシャルエネルギーの時間変化をプロットします。

シミュレーション中の温度や圧力、ポテンシャルエネルギーなどの熱力学量の時間変化は`.log`ファイルにも書かれますが、より詳しい情報が`.edr`ファイルに記録されます。

この`.edr`ファイルの内容を、人間が読みやすい形に変換するのが、`gmx dump`コマンドです。

```
gmx dump -e 00001.edr
```

ですが、こうして変換されたファイルも、あとのデータ処理にはあまり便利ではありませんそこで、これをさらに自作スクリプト`undump.py`を使って、表形式に変換します。

```
gmx dump -e 00001.edr | python undump.pu > 00001.txt
```

このファイルをダウンロードし、てきとうなツール(Excel?)を使って開いて、時間とポテンシャルエネルギーの関係をプロットして下さい。

## 6. 融点の推定

十分長いシミュレーションを行えば、融点より高温では氷は完全に融解し、低温では完全に凍結するはずです。そして、ポテンシャルエネルギーは一定値になります。

一定値になるまでの時間は、融点から遠いほど短くなるはずです(ただし、上にも書いたように、温度がとても低くなると、分子運動が遅くなるために凍るまでにまた時間がかかるようになります。)

仮に、完全凍結/完全融解までの時間が、融点からの温度差に反比例するものとします。その場合は、温度を横軸にとり、縦軸にポテンシャルエネルギーの変化が完了するまでの時間の逆数をとれば、低温側、高温側それぞれに曲線を描け、それらは融点で0に漸近する(すなわち、融点丁度では、いくらまっても凍りも融けもしない)と思われます。

しかし、融点に近づいてくると、完全に凍るまでの時間がかかりすぎます。また、十分に長い計算ができない場合も、完全な凍結を確認できません。そんな場合は、最終的なポテンシャルエネルギーが得られるのを待つ代わりに、ポテンシャルエネルギーの減少/増加速度を測定し、その逆数を縦軸にとる、という方法もあります。

## 課題

全員で手分けして、250 Kから290 Kまで(5 K間隔で?)のポテンシャルエネルギーの時間変化を採取し、それらの結果から、TIP4P/Iceの融点を推定して下さい。

下の論文[^1]によれば、TIP4P/Iceの融点は270 Kとなっていますが、今回は高速化のために、分子数がかなり少ない系でシミュレーションを行っています。そのせいで、融点が270 Kからずれる可能性があります。

270 Kや、それに近い温度では、いつまでたっても凍りも融けもしない可能性がありますので、あまり長い計算をする必要はありません。

# References

[^1] Conde, M. M., Rovere, M. & Gallo, P. High precision determination of the melting points of water TIP4P/2005 and water TIP4P/Ice models by the direct coexistence technique. J. Chem. Phys. 147, 244506 (2017)
